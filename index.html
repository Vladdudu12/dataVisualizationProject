<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="styles.css">

    <script type="text/javascript" src="index.js"></script>
    <script>
        function init() {
            populateIndicatorList();
            populateCountryList();
            populateYearList();
        }

        function populateIndicatorList() {
            const indicatorsArray = ["PIB", "POP", "SV"];
    
            let selectIndicatorElement = document.getElementById("selectIndicator");
            if(selectIndicatorElement !== null) {
                indicatorsArray.forEach(x => {
                    //console.log(x);
                    selectIndicatorElement.innerHTML += `<option value='${x}'>${x}</option>`;
                })
            }
    
        }
        
        function populateCountryList(){
            const countriesArray = [
                "BE", "BG", "CZ", "DK", "DE", "EE",
                "IE", "EL", "ES", "FR", "HR", "IT",
                "CY", "LV", "LT", "LU", "HU", "MT",
                "NL", "AT", "PL", "PT", "RO", "SI",
                "SK", "FI", "SE"];
            
                countriesArray.sort((a,b) => sortArray);
            let selectCountryElement = document.getElementById("selectCountry");
            if(selectCountryElement !== null) {
                countriesArray.forEach(x => {
                    selectCountryElement.innerHTML += `<option value='${x}'>${x}</option>`;
                })
            }
        }

        function populateYearList() {
            let selectYearElement = document.getElementById("selectYear");

            if(selectYearElement !== null) {
                for(let i = 0; i <= 23; i++) {
                    selectYearElement.innerHTML += `<option value='${2023-i}'>${2023-i}</option>`
                }
            }
        }
    
        function resetTbody() {
            let oldTableBody = document.querySelector("tbody");
            let newTableBody = document.createElement('tbody');
            oldTableBody.parentNode.replaceChild(newTableBody, oldTableBody);
        }

        function filterYearButton() {
            let selectYearElement = document.getElementById("selectYear");
            let year = selectYearElement.value;
            let array = filterDatasetByYear(year);
            resetTbody();

            let tableBody = document.querySelector("tbody");


            let sumaPIB = 0;
            let sumaSV = 0;
            let sumaPop = 0;
            //TODO: de sortat in functie de tara, si extras indicatori

            array.sort((a, b) => sortObjectArray(a,b));
            for(let i = 0; i < array.length; i= i + 3) {
                let row = tableBody.insertRow(-1);
                //TARA
                let cell1 = row.insertCell(0);
                cell1.innerHTML = `${array[i].tara}`;
                
                //2
                //PIB
                let cell2 = row.insertCell(1);
                cell2.innerHTML = `${array[i+2].valoare}`;
                sumaPIB += array[i+2].valoare;    
                
                //0
                //SPERANTA DE VIATA
                let cell3 = row.insertCell(2);
                cell3.innerHTML = `${array[i].valoare}`;
                sumaSV += array[i].valoare;    
                    
                //1
                //POPULATIE
                let cell4 = row.insertCell(3);
                cell4.innerHTML = `${array[i+1].valoare}`;
                sumaPop += array[i+1].valoare;    
            }

            console.log(array.length);
            let nrTari = array.length/3;

            console.log(`Suma PIB:${sumaPIB}; Suma SV:${sumaSV}; Suma Pop:${sumaPop}`);
            console.log(`Medie PIB:${sumaPIB/nrTari}; Medie SV:${sumaSV/nrTari}; Medie Pop:${sumaPop/nrTari}`);

        }

        function filterButton() {
            let selectCountryElement = document.getElementById("selectCountry");
            let selectIndicatorElement = document.getElementById("selectIndicator");
    
            let country = selectCountryElement.value;
            let indicator = selectIndicatorElement.value;
            // console.log(indicator);
            // console.log(country);
            let data = filterDatasetByCountryAndIndicator(country, indicator);
            console.log(data);
            desenareHistogramaSVG(country, indicator, data);
        }

        function sortObjectArray(a, b) {
            const taraA = a.tara.toUpperCase();
            const taraB = b.tara.toUpperCase();

            if(taraA < taraB) {
                return -1;
            }
            
            if(taraA > taraB){
                return 1;
            }

            return 0;
        }
    
        function sortArray(a, b) {
            const taraA = a.toUpperCase();
            const taraB = b.toUpperCase();

            if(taraA < taraB) {
                return -1;
            }
            
            if(taraA > taraB){
                return 1;
            }

            return 0;
        }

        function desenareHistogramaSVG(country, indicator, data) {
            let svg = document.querySelector("svg");
            let yearAxis = document.getElementById("yearsAxis");
            let valuePoints = document.getElementById("valuePoints"); 
            let valueLines = document.getElementById("valueLines"); 
            let valueText = document.getElementById("valueText"); 

            while (yearAxis.firstChild) {
                yearAxis.removeChild(yearAxis.firstChild);
            }

            while (valuePoints.firstChild) {
                valuePoints.removeChild(valuePoints.firstChild);
            }

            while (valueLines.firstChild) {
                valueLines.removeChild(valueLines.firstChild);
            }

            while (valueText.firstChild) {
                valueText.removeChild(valueText.firstChild);
            }

            let yearOffset = Math.floor((960 - 40 * 2 - 20)/data.length);
            // console.log(yearOffset);
            const f = 500 / Math.max(...data.map(x=>x.valoare));
            // console.log(f);
            for(let i = 0; i < data.length; i++) {
                yearAxis.innerHTML += `<line x1="${40 + yearOffset * (i+1)}" y1="490" x2="${40 + yearOffset * (i+1)}" y2="510" stroke="black"/>`;
                yearAxis.innerHTML += `<text x="${40 + yearOffset * (i+1) - 12.5}" y="520" font-size="0.7rem">${2000 + i}</text>`;
                valuePoints.innerHTML += `<circle cx="${40 + yearOffset * (i+1)}" cy="${data[i].valoare * f * 0.8}" r="2" />`
                valueText.innerHTML +=  `<text x="${40 + yearOffset * (i+1)}" y="${data[i].valoare * f * 0.79}" font-size="10">${data[i].valoare}</text>` 
            }
            

            console.log(valuePoints.childNodes);
            for(let i = 0; i < valuePoints.childNodes.length - 1; i++) {
                const cx1 = valuePoints.childNodes[i].cx.animVal.value;
                const cy1 = valuePoints.childNodes[i].cy.animVal.value;
                const cx2 = valuePoints.childNodes[i+1].cx.animVal.value;
                const cy2 = valuePoints.childNodes[i+1].cy.animVal.value;
                // console.log(valuePoints.childNodes[i].cx.animVal.value);
                // console.log(valuePoints.childNodes[i].cy.animVal.value);
                valueLines.innerHTML += `<line x1="${cx1}" x2="${cx2}" y1="${cy1}" y2="${cy2}" stroke="blue" stroke-width="1"/>`;

            }
            
            // console.log(svg);
            // console.log(yearAxis);
        }

        
        document.addEventListener("DOMContentLoaded", init);
    </script>
    
</head>
<body>
    <!-- lista de țări este: BE, BG, CZ, DK, DE, EE, IE, EL, ES, FR, HR, IT, CY, LV, LT, LU, HU, MT, NL, AT, PL, PT, RO, SI, SK, FI, SE  -->
    <select name="selectCountry" id="selectCountry"></select>

    <!-- PIB pe cap de locuitor/ Speranta Viata / Populatie pentru țările UE pentru ultimii 15 ani  -->
    <!-- PIB, POP, SV-->
    <select name="selectIndicator" id="selectIndicator"></select>

    <!-- <input type="button" name="btnFilter" onClick="filterDataset" -->
    <input type="button" name="btnFilter" id="btnFilter" onclick='filterButton()' value="Filtrare">

    <select name="selectYear" id="selectYear"></select>

    <input type="button" name="btnFilter" id="btnFilterYear" onclick='filterYearButton()' value="Filtrare An">


    <br>
    <table id="table">
        <thead>
            <th>Tara</th>
            <th>PIB pe cap de locuitor</th>
            <th>Speranta de Viata</th>
            <th>Populatie</th>
        </thead>
        <tbody>
        </tbody>
    </table>

    <br/>
    
    <svg width="960px" height="540px">
        <line x1="40" x2="40" y1="500" y2="40" stroke="black" stroke-width="2"/>
        <line x1="40" x2="920" y1="500" y2="500" stroke="black" stroke-width="2"/>
        <polyline points="30 50 40 40 50 50" stroke="black" stroke-width="2" fill="none" stroke-linecap="butt" stroke-linejoin="round"/>
        <polyline points="910 490 920 500 910 510" stroke="black" stroke-width="2" fill="none" stroke-linecap="butt" stroke-linejoin="round"/>
        <text x="10" y="520" font-weight="bold">O(0,0)</text>
        <text x="480" y="535" font-weight="bold">Ani</text>
        <text transform="translate(20, 300) rotate(-90)" font-weight="bold">Indicator</text>
        
        <g id="yearsAxis"></g>
        <g id="valuePoints"></g>
        <g id="valueLines"></g>
        <g id="valueText"></g>

    </svg>
    <!-- <svg version="1.2" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="graph" aria-labelledby="title" role="img">
        <title id="title">A line chart showing some information</title>

        <g class="grid x-grid" id="xGrid">
            <line x1="90" x2="90" y1="5" y2="371"></line>
        </g>
        <g class="grid y-grid" id="yGrid">
            <line x1="90" x2="705" y1="370" y2="370"></line>
        </g>
            <g class="labels x-labels">
            <text x="100" y="400">2008</text>
            <text x="246" y="400">2009</text>
            <text x="392" y="400">2010</text>
            <text x="538" y="400">2011</text>
            <text x="684" y="400">2012</text>
            <text x="400" y="440" class="label-title">Year</text>
        </g>
        <g class="labels y-labels">
            <text x="80" y="15">15</text>
            <text x="80" y="131">10</text>
            <text x="80" y="248">5</text>
            <text x="80" y="373">0</text>
            <text x="50" y="200" class="label-title">Price</text>
        </g>
        <g class="data" data-setname="Our first data set" id="grupDate">
            <line x1="90" y1="192" x2="240" y2="141" stroke-width="1" stroke="blue"/>
            <line x1="240" y1="141" x2="388" y2="179" stroke-width="1" stroke="blue"/>
            <line x1="388" y1="179" x2="531" y2="200" stroke-width="1" stroke="blue"/>
            <line x1="531" y1="200" x2="677" y2="104" stroke-width="1" stroke="blue"/>
            <circle cx="90" cy="192" data-value="7.2" r="3"></circle>
            <circle cx="240" cy="141" data-value="8.1" r="3"></circle>
            <circle cx="388" cy="179" data-value="7.7" r="3"></circle>
            <circle cx="531" cy="200" data-value="6.8" r="3"></circle>
            <circle cx="677" cy="104" data-value="6.7" r="3"></circle>
        </g>
    </svg> -->
    
</body>
</html>